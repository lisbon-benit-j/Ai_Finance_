{% extends "base.html" %}

{% block title %}Reports{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-2xl font-bold mb-6">Financial Reports</h1>
    
    <!-- Year Selector -->
    <div class="bg-white p-4 rounded-lg shadow-md mb-6">
        <form method="GET" action="{{ url_for('reports') }}" class="flex items-center space-x-4">
            <label for="year" class="text-gray-700">Select Year:</label>
            <select id="year" name="year" onchange="this.form.submit()"
                    class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                {% for year in available_years %}
                    <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
        </form>
    </div>

    <!-- Monthly Spending Chart -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 class="text-xl font-semibold mb-4">Monthly Spending - {{ selected_year }}</h2>
        <div class="h-80">
            <canvas id="monthlyChart"></canvas>
        </div>
    </div>

    <!-- Category Breakdown -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Spending by Category - {{ selected_year }}</h2>
            <div class="h-80">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Top Categories</h2>
            <div class="space-y-4">
                {% for label, total in zipped_categories %}
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="font-medium">{{ label }}</span>
                        <span>${{ "%.2f"|format(total) }}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full" 
                             style="width: {{ (total / category_data[0] * 100) if category_data else 0 }}%"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Monthly Spending Chart
    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    const monthlyChart = new Chart(monthlyCtx, {
        type: 'bar',
        data: {
            labels: {{ months | tojson | safe }},
            datasets: [{
                label: 'Monthly Spending',
                data: {{ monthly_totals | tojson | safe }},
                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value;
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '$' + context.raw.toFixed(2);
                        }
                    }
                }
            }
        }
    });

    // Category Spending Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    const categoryChart = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: {{ category_labels | tojson | safe }},
            datasets: [{
                data: {{ category_data | tojson | safe }},
                backgroundColor: [
                    'rgba(59, 130, 246, 0.7)',
                    'rgba(16, 185, 129, 0.7)',
                    'rgba(245, 158, 11, 0.7)',
                    'rgba(139, 92, 246, 0.7)',
                    'rgba(244, 63, 94, 0.7)',
                    'rgba(20, 184, 166, 0.7)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '$' + context.raw.toFixed(2);
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
{% endblock %}